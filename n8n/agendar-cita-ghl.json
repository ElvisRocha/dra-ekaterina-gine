{
  "name": "Dra. Ekaterina Malaspina - Agendar Cita GHL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "agendar-cita",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "81b0cfd0-86f2-4843-89b4-752c66ea688c",
      "name": "Recibir Datos Cita",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [200, 300],
      "webhookId": "d2a98ced-a7c9-4040-96c4-e8d7f14d6f24"
    },
    {
      "parameters": {
        "jsCode": "// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Preparar datos del contacto y la cita\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst body = $input.first().json.body;\n\nconst { patient, service, appointment } = body;\n\n// Formatear telÃ©fono para GHL (formato internacional +506XXXXXXXX)\nlet phone = (patient.phone || '').replace(/\\D/g, '');\nif (phone.startsWith('506')) {\n  phone = '+' + phone;\n} else if (phone.length === 8) {\n  phone = '+506' + phone;\n} else {\n  phone = '+' + phone;\n}\n\n// Calcular startTime y endTime en ISO 8601 (zona CR = UTC-6)\nconst [year, month, day] = appointment.date.split('-').map(Number);\nconst [hour, minute]     = appointment.time.split(':').map(Number);\n\n// Offset Costa Rica: -06:00\nconst pad = n => String(n).padStart(2, '0');\nconst crOffset = '-06:00';\nconst startTime = `${appointment.date}T${pad(hour)}:${pad(minute)}:00${crOffset}`;\n\nconst durationMinutes = service.durationMinutes || 30;\nconst endTotalMinutes = hour * 60 + minute + durationMinutes;\nconst endHour   = Math.floor(endTotalMinutes / 60) % 24;\nconst endMinute = endTotalMinutes % 60;\nconst endTime   = `${appointment.date}T${pad(endHour)}:${pad(endMinute)}:00${crOffset}`;\n\nreturn [{\n  json: {\n    locationId: 'REEMPLAZAR_CON_TU_GHL_LOCATION_ID',\n    calendarId: 'DqZ35XwjFseg04ZGRLcu',\n    patient: {\n      firstName:      patient.firstName,\n      lastName:       patient.lastName,\n      email:          patient.email,\n      phone,\n      identification: patient.identification,\n    },\n    appointment: {\n      startTime,\n      endTime,\n      title: `Cita: ${service.name}`,\n      timezone: 'America/Costa_Rica',\n    },\n    service,\n  }\n}];"
      },
      "id": "80dc84a1-6d01-4e52-bd08-44bbd8494eea",
      "name": "Preparar Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueErrorOutput",
      "position": [460, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://services.leadconnectorhq.com/contacts/search/duplicate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer REEMPLAZAR_CON_TU_GHL_PRIVATE_API_KEY"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "locationId",
              "value": "={{ $json.locationId }}"
            },
            {
              "name": "email",
              "value": "={{ $json.patient.email }}"
            },
            {
              "name": "number",
              "value": "={{ $json.patient.phone }}"
            }
          ]
        }
      },
      "id": "af87d06d-b27f-4265-bd30-69abc75ff7d7",
      "name": "GHL - Buscar Contacto Duplicado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "onError": "continueErrorOutput",
      "position": [720, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-001",
              "leftValue": "={{ $json.contact }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "rightType": "any"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "72cdc595-202b-4ef4-8b8a-ad86d34fb7bc",
      "name": "Â¿Contacto existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [980, 300]
    },
    {
      "parameters": {
        "jsCode": "// Contacto existente â€” extraer ID y marcar flag\nconst searchResult = $input.first().json;\nconst prevData     = $('Preparar Datos').first().json;\n\nreturn [{\n  json: {\n    ...prevData,\n    contactId:      searchResult.contact.id,\n    contactExisted: true,\n  }\n}];"
      },
      "id": "3db3b950-af12-44f8-b46c-52b0540b7e1f",
      "name": "Usar Contacto Existente",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueErrorOutput",
      "position": [1240, 180]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/contacts/",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer REEMPLAZAR_CON_TU_GHL_PRIVATE_API_KEY"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"firstName\": \"{{ $('Preparar Datos').first().json.patient.firstName }}\",\n  \"lastName\":  \"{{ $('Preparar Datos').first().json.patient.lastName }}\",\n  \"email\":     \"{{ $('Preparar Datos').first().json.patient.email }}\",\n  \"phone\":     \"{{ $('Preparar Datos').first().json.patient.phone }}\",\n  \"locationId\":\"{{ $('Preparar Datos').first().json.locationId }}\",\n  \"source\":    \"Formulario Web - Cita\",\n  \"country\":   \"CR\",\n  \"timezone\":  \"America/Costa_Rica\",\n  \"tags\":      [\"nueva-paciente\"],\n  \"customFields\": [\n    { \"key\": \"contact.nmero_de_identificacin\", \"field_value\": \"{{ $('Preparar Datos').first().json.patient.identification }}\" }\n  ]\n}"
      },
      "id": "cd18131f-d8c5-4a6a-9618-39eff1510ed9",
      "name": "GHL - Crear Nuevo Contacto",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "onError": "continueErrorOutput",
      "position": [1240, 420]
    },
    {
      "parameters": {
        "jsCode": "// Contacto reciÃ©n creado â€” extraer ID y marcar flag\nconst createResult = $input.first().json;\nconst prevData     = $('Preparar Datos').first().json;\n\nreturn [{\n  json: {\n    ...prevData,\n    contactId:      createResult.contact?.id ?? createResult.id,\n    contactExisted: false,\n  }\n}];"
      },
      "id": "03d0e118-9b35-4a38-9fcb-013af1702b0f",
      "name": "Marcar Contacto Nuevo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueErrorOutput",
      "position": [1500, 420]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/calendars/events/appointments",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer REEMPLAZAR_CON_TU_GHL_PRIVATE_API_KEY"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"calendarId\":        \"{{ $json.calendarId }}\",\n  \"locationId\":        \"{{ $json.locationId }}\",\n  \"contactId\":         \"{{ $json.contactId }}\",\n  \"startTime\":         \"{{ $json.appointment.startTime }}\",\n  \"endTime\":           \"{{ $json.appointment.endTime }}\",\n  \"title\":             \"{{ $json.appointment.title }}\",\n  \"appointmentStatus\": \"new\",\n  \"timeZone\":          \"America/Costa_Rica\"\n}"
      },
      "id": "89f04fcb-d05b-44d9-b9a7-b5084acdb64c",
      "name": "GHL - Crear Cita en Calendario",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "onError": "continueErrorOutput",
      "position": [2020, 300]
    },
    {
      "parameters": {
        "jsCode": "// Armar respuesta final para el frontend\nconst existingItems = $('Usar Contacto Existente').all();\nconst newItems      = $('Marcar Contacto Nuevo').all();\nconst citaResp      = $input.first().json;\n\nlet contactId      = '';\nlet contactExisted = false;\n\nif (existingItems.length > 0) {\n  contactId      = existingItems[0].json.contactId;\n  contactExisted = true;\n} else if (newItems.length > 0) {\n  contactId      = newItems[0].json.contactId;\n  contactExisted = false;\n}\n\nreturn [{\n  json: {\n    success:        true,\n    contactId,\n    contactExisted,\n    appointmentId:  citaResp.id ?? citaResp.appointmentId ?? '',\n  }\n}];"
      },
      "id": "a02a739e-acbd-46cc-9b97-cbceccb14b50",
      "name": "Construir Respuesta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "onError": "continueErrorOutput",
      "position": [2280, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "c1e4a5b7-e6d4-478d-809a-abd98ccda9f0",
      "name": "Responder Ã‰xito",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2540, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": false, \"error\": \"{{ $json.message }}\" }",
        "options": {
          "responseCode": 500,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "e69e4345-7187-4e28-9a96-e2420ea5e25c",
      "name": "Responder Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2280, 500]
    },
    {
      "parameters": {
        "jsCode": "// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Preparar templates de notificaciÃ³n para la paciente\n// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst existingItems = $('Usar Contacto Existente').all();\nconst newItems      = $('Marcar Contacto Nuevo').all();\nconst merged = existingItems.length > 0 ? existingItems[0].json : newItems[0].json;\nconst { patient, appointment, service, contactId, locationId } = merged;\n\n// Parsear fecha y hora desde startTime (YYYY-MM-DDTHH:mm:ss-06:00)\nconst [year, month, day] = appointment.startTime.substring(0, 10).split('-').map(Number);\nconst [hour, minute] = appointment.startTime.substring(11, 16).split(':').map(Number);\n\n// Formatear fecha en espaÃ±ol\nconst meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];\nconst diasSemana = ['domingo','lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado'];\nconst fechaObj = new Date(year, month - 1, day);\nconst dateFormatted = `${diasSemana[fechaObj.getDay()]}, ${day} de ${meses[month - 1]} de ${year}`;\n\n// Formatear hora (12 h con AM/PM)\nconst period = hour >= 12 ? 'PM' : 'AM';\nconst hour12 = hour % 12 || 12;\nconst pad = n => String(n).padStart(2, '0');\nconst timeFormatted = `${hour12}:${pad(minute)} ${period}`;\n\nconst firstName  = patient.firstName;\nconst serviceName = service.name;\nconst duration   = service.durationMinutes || 30;\n\n// â”€â”€ WhatsApp (texto plano con formato WhatsApp) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst whatsappMessage =\n`ğŸŒ¸ *Consultorio Dra. Ekaterina Malaspina*\n\nHola, ${firstName} ğŸ˜Š\n\nTu cita ha sido *confirmada exitosamente*. AquÃ­ tienes el resumen:\n\nğŸ“‹ *Detalle de tu cita:*\nğŸ‘©â€âš•ï¸ *Servicio:* ${serviceName}\nğŸ“… *Fecha:* ${dateFormatted}\nâ° *Hora:* ${timeFormatted}\nâ± *DuraciÃ³n:* ${duration} minutos\n\nğŸ“Œ *Recordatorios importantes:*\nâ€¢ Llega 10 minutos antes de tu cita\nâ€¢ Si necesitas cancelar, avÃ­sanos con al menos 24 horas de anticipaciÃ³n\nâ€¢ Trae tu documento de identidad\n\nÂ¡Te esperamos con mucho cariÃ±o! ğŸ’–\n_Dra. Ekaterina Malaspina_\n_GinecologÃ­a & Obstetricia_`;\n\n// â”€â”€ Template Email HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nconst emailSubject = `âœ… Cita confirmada â€“ ${serviceName} | ${dateFormatted}`;\n\nconst emailHtml =\n`<!DOCTYPE html><html><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width,initial-scale=1.0'><title>Cita Confirmada</title></head><body style='margin:0;padding:0;background-color:#FFF5F0;font-family:Arial,sans-serif;'><table width='100%' cellpadding='0' cellspacing='0' border='0' style='background-color:#FFF5F0;'><tr><td align='center' style='padding:32px 16px;'><table width='600' cellpadding='0' cellspacing='0' border='0' style='max-width:600px;width:100%;background-color:#ffffff;border-radius:16px;overflow:hidden;box-shadow:0 4px 30px rgba(160,36,90,0.10);'><!-- HEADER --><tr><td style='background:linear-gradient(135deg,#E05A47 0%,#C4237B 50%,#A0245A 100%);padding:36px 40px 28px;text-align:center;'><p style='margin:0 0 6px;color:rgba(255,255,255,0.85);font-size:12px;letter-spacing:2px;text-transform:uppercase;font-weight:700;font-family:Arial,sans-serif;'>Consultorio</p><h1 style='margin:0;color:#ffffff;font-family:Georgia,serif;font-size:28px;font-weight:400;font-style:italic;'>Dra. Ekaterina Malaspina</h1><p style='margin:6px 0 0;color:rgba(255,255,255,0.80);font-size:13px;font-family:Arial,sans-serif;'>GinecologÃ­a &amp; Obstetricia</p></td></tr><!-- BANNER Ã‰XITO --><tr><td style='background-color:#FBF0F5;padding:22px 40px;text-align:center;border-bottom:1px solid #F0DEE8;'><p style='margin:0;font-size:30px;'>âœ…</p><h2 style='margin:8px 0 0;color:#A0245A;font-family:Georgia,serif;font-size:21px;font-weight:500;'>Â¡Tu cita ha sido confirmada!</h2></td></tr><!-- SALUDO --><tr><td style='padding:28px 40px 16px;'><p style='margin:0;color:#3E2723;font-size:15px;line-height:1.8;font-family:Arial,sans-serif;'>Estimada <strong style='color:#A0245A;'>${firstName}</strong>,</p><p style='margin:10px 0 0;color:#3E2723;font-size:15px;line-height:1.8;font-family:Arial,sans-serif;'>Tu cita ha sido agendada exitosamente. A continuaciÃ³n encontrarÃ¡s el resumen de tu cita:</p></td></tr><!-- TARJETA DE CITA --><tr><td style='padding:0 40px 20px;'><table width='100%' cellpadding='0' cellspacing='0' border='0' style='background-color:#FFF5F8;border:1px solid #F0D0E0;border-radius:12px;overflow:hidden;'><tr><td style='padding:18px 22px;border-bottom:1px solid #F0D0E0;'><p style='margin:0;font-size:10px;color:#A0245A;text-transform:uppercase;letter-spacing:2px;font-weight:700;font-family:Arial,sans-serif;'>Servicio</p><p style='margin:5px 0 0;font-size:17px;color:#3E2723;font-family:Georgia,serif;font-style:italic;'>${serviceName}</p></td></tr><tr><td style='padding:16px 22px;border-bottom:1px solid #F0D0E0;'><table width='100%' border='0' cellpadding='0' cellspacing='0'><tr><td width='50%' style='padding-right:12px;'><p style='margin:0;font-size:10px;color:#A0245A;text-transform:uppercase;letter-spacing:2px;font-weight:700;font-family:Arial,sans-serif;'>Fecha</p><p style='margin:5px 0 0;font-size:15px;color:#3E2723;font-family:Arial,sans-serif;'>ğŸ“… ${dateFormatted}</p></td><td width='50%' style='padding-left:12px;border-left:1px solid #F0D0E0;'><p style='margin:0;font-size:10px;color:#A0245A;text-transform:uppercase;letter-spacing:2px;font-weight:700;font-family:Arial,sans-serif;'>Hora</p><p style='margin:5px 0 0;font-size:15px;color:#3E2723;font-family:Arial,sans-serif;'>â° ${timeFormatted}</p></td></tr></table></td></tr><tr><td style='padding:16px 22px;'><p style='margin:0;font-size:10px;color:#A0245A;text-transform:uppercase;letter-spacing:2px;font-weight:700;font-family:Arial,sans-serif;'>DuraciÃ³n estimada</p><p style='margin:5px 0 0;font-size:15px;color:#3E2723;font-family:Arial,sans-serif;'>â± ${duration} minutos</p></td></tr></table></td></tr><!-- RECORDATORIOS --><tr><td style='padding:0 40px 24px;'><table width='100%' cellpadding='0' cellspacing='0' border='0' style='background-color:#FFF9F0;border-left:3px solid #E05A47;border-radius:0 8px 8px 0;'><tr><td style='padding:16px 20px;'><p style='margin:0 0 8px;font-size:11px;color:#E05A47;text-transform:uppercase;letter-spacing:1px;font-weight:700;font-family:Arial,sans-serif;'>Recordatorios importantes</p><p style='margin:0;font-size:13px;color:#3E2723;line-height:1.9;font-family:Arial,sans-serif;'>â€¢ Por favor llega <strong>10 minutos antes</strong> de tu cita.<br>â€¢ Si necesitas cancelar o reprogramar, avÃ­sanos con <strong>al menos 24 horas</strong> de anticipaciÃ³n.<br>â€¢ Trae tu <strong>documento de identidad</strong>.</p></td></tr></table></td></tr><!-- CONTACTO --><tr><td style='padding:0 40px 24px;'><table width='100%' cellpadding='0' cellspacing='0' border='0' style='background-color:#FBF0F5;border-radius:8px;'><tr><td style='padding:16px 20px;text-align:center;'><p style='margin:0 0 8px;font-size:11px;color:#A0245A;text-transform:uppercase;letter-spacing:1px;font-weight:700;font-family:Arial,sans-serif;'>Â¿Necesitas ayuda?</p><p style='margin:0;font-size:13px;color:#3E2723;font-family:Arial,sans-serif;'>ğŸ“ +506 6245-0393 &nbsp;|&nbsp; +506 2460-4325</p><p style='margin:4px 0 0;font-size:13px;color:#3E2723;font-family:Arial,sans-serif;'>ğŸ“ Barrio San Roque, Ciudad Quesada, Alajuela</p></td></tr></table></td></tr><!-- CIERRE --><tr><td style='padding:0 40px 28px;'><p style='margin:0;color:#3E2723;font-size:15px;line-height:1.8;font-family:Arial,sans-serif;'>Â¡Te esperamos con mucho cariÃ±o! ğŸŒ¸</p><p style='margin:14px 0 2px;font-family:Georgia,serif;font-style:italic;color:#A0245A;font-size:18px;'>Dra. Ekaterina Malaspina</p><p style='margin:0;font-size:13px;color:#888888;font-family:Arial,sans-serif;'>GinecologÃ­a &amp; Obstetricia</p></td></tr><!-- FOOTER --><tr><td style='background-color:#FBF0F5;padding:18px 40px;text-align:center;border-top:1px solid #F0DEE8;'><p style='margin:0;font-size:11px;color:#aaaaaa;font-family:Arial,sans-serif;'>Este es un mensaje automÃ¡tico, por favor no responder directamente a este correo.</p><p style='margin:6px 0 0;font-size:11px;color:#A0245A;font-family:Arial,sans-serif;'>Â© 2025 Dra. Ekaterina Malaspina Riazanova Â· GinecologÃ­a &amp; Obstetricia</p></td></tr></table></td></tr></table></body></html>`;\n\nreturn [{\n  json: {\n    contactId,\n    locationId,\n    firstName,\n    email:           patient.email,\n    phone:           patient.phone,\n    whatsappMessage,\n    emailSubject,\n    emailHtml,\n  }\n}];"
      },
      "id": "b5cc7ec6-1b33-44d7-9f9d-6096c7f292ba",
      "name": "Preparar Notificaciones",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2280, 580]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer REEMPLAZAR_CON_TU_GHL_PRIVATE_API_KEY"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ contactId: $json.contactId, locationId: $json.locationId }) }}"
      },
      "id": "d57b8800-1a23-4c2c-84cd-c6a876565ed1",
      "name": "GHL - Obtener ConversaciÃ³n",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2540, 580]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer REEMPLAZAR_CON_TU_GHL_PRIVATE_API_KEY"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ type: 'WhatsApp', conversationId: $json.conversation?.id ?? $json.id, message: $('Preparar Notificaciones').first().json.whatsappMessage }) }}"
      },
      "id": "c0426608-32c4-4709-90e5-f1bbbaa4b32c",
      "name": "WhatsApp - Confirmar Cita",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2800, 460]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/conversations/messages",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer REEMPLAZAR_CON_TU_GHL_PRIVATE_API_KEY"
            },
            {
              "name": "Version",
              "value": "2021-04-15"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ type: 'Email', conversationId: $json.conversation?.id ?? $json.id, subject: $('Preparar Notificaciones').first().json.emailSubject, html: $('Preparar Notificaciones').first().json.emailHtml }) }}"
      },
      "id": "ee739017-0b29-4394-9969-3ceab8457ec4",
      "name": "Email - Confirmar Cita",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2800, 700]
    }
  ],
  "connections": {
    "Recibir Datos Cita": {
      "main": [
        [{ "node": "Preparar Datos", "type": "main", "index": 0 }]
      ]
    },
    "Preparar Datos": {
      "main": [
        [{ "node": "GHL - Buscar Contacto Duplicado", "type": "main", "index": 0 }],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "GHL - Buscar Contacto Duplicado": {
      "main": [
        [{ "node": "Â¿Contacto existe?", "type": "main", "index": 0 }],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "Â¿Contacto existe?": {
      "main": [
        [{ "node": "Usar Contacto Existente",    "type": "main", "index": 0 }],
        [{ "node": "GHL - Crear Nuevo Contacto", "type": "main", "index": 0 }]
      ]
    },
    "Usar Contacto Existente": {
      "main": [
        [{ "node": "GHL - Crear Cita en Calendario", "type": "main", "index": 0 }],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "GHL - Crear Nuevo Contacto": {
      "main": [
        [{ "node": "Marcar Contacto Nuevo", "type": "main", "index": 0 }],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "Marcar Contacto Nuevo": {
      "main": [
        [{ "node": "GHL - Crear Cita en Calendario", "type": "main", "index": 0 }],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "GHL - Crear Cita en Calendario": {
      "main": [
        [
          { "node": "Construir Respuesta",    "type": "main", "index": 0 },
          { "node": "Preparar Notificaciones", "type": "main", "index": 0 }
        ],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "Construir Respuesta": {
      "main": [
        [{ "node": "Responder Ã‰xito", "type": "main", "index": 0 }],
        [{ "node": "Responder Error", "type": "main", "index": 0 }]
      ]
    },
    "Preparar Notificaciones": {
      "main": [
        [{ "node": "GHL - Obtener ConversaciÃ³n", "type": "main", "index": 0 }]
      ]
    },
    "GHL - Obtener ConversaciÃ³n": {
      "main": [
        [
          { "node": "WhatsApp - Confirmar Cita", "type": "main", "index": 0 },
          { "node": "Email - Confirmar Cita",    "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2026-02-27T00:00:00.000Z",
  "versionId": "46faa6a8-5cf6-4f80-acb7-36605abb0894",
  "id": "22bfbec5-59f8-4af0-92a1-4bfd508a6033",
  "active": false
}
